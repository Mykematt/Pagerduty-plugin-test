agents:
  queue: "mac"

steps:
  # Test 6: Build failure detection (check: build)
  # This step succeeds but detects that previous steps in the build have failed
  - label: ":building_construction: Test 6 - Build Failure Detection"
    key: "test-6"
    command: |
      echo "This step succeeds, but checking if build is failing..."
      echo "Previous steps have failed, so build status should be 'failing'"
      echo "Plugin should detect build-level failure and create incident"
      echo ""
      echo "DEBUG: Checking token availability..."
      if [[ -n "\${BUILDKITE_AGENT_ACCESS_TOKEN}" ]]; then
        echo "✅ BUILDKITE_AGENT_ACCESS_TOKEN is available"
      else
        echo "❌ BUILDKITE_AGENT_ACCESS_TOKEN is NOT available"
      fi
    plugins:
      - https://github.com/buildkite-plugins/incident-pagerduty-buildkite-plugin.git#22898ca:
          integration-key: ${INTEGRATION_KEY}
          check: build
          debug: true

  # # Test 7: Both job and build failure detection (check: both)
  # - label: ":double_vertical_bar: Test 7 - Both Job & Build Detection"
  #   key: "test-7"
  #   depends_on: "test-6"
  #   allow_dependency_failure: true
  #   command: |
  #     echo "Testing both job and build failure detection..."
  #     exit 1
  #   plugins:
  #     - https://github.com/buildkite-plugins/incident-pagerduty-buildkite-plugin.git#22898ca:
  #         integration-key: ${INTEGRATION_KEY}
  #         check: both

  # Test 8: Success case - should NOT create incident
  - label: ":white_check_mark: Test 8 - Success (No Incident Expected)"
    key: "test-8"
    command: |
      echo "This step succeeds - no incident should be created"
      echo "Verifying plugin doesn't create false positives"
    plugins:
      - https://github.com/buildkite-plugins/incident-pagerduty-buildkite-plugin.git#22898ca:
          integration-key: ${INTEGRATION_KEY}
        
secrets:
  INTEGRATION_KEY: pagerduty_integration_key
