agents:
  queue: "mac"

steps:
  - label: ":x: Simulated failing job"
    key: "fail-setup"
    command: |
      echo "Simulating a failing job to exercise build-level detection"
      exit 1
    continue_on_failure: true

  - label: ":building_construction: Build Failure Detection"
    key: "test-1"
    command: |
      echo "This step succeeds, but checking if build is failing..."
    plugins:
      - https://github.com/buildkite-plugins/incident-pagerduty-buildkite-plugin.git#73e5852:
          integration-key: ${INTEGRATION_KEY}
          check: build
          debug: true

  - label: ":white_check_mark: Success (No Incident Expected)"
    key: "test-2"
    command: |
      echo "This step succeeds - no incident should be created"
      echo "Verifying plugin doesn't create false positives"
    plugins:
      - https://github.com/buildkite-plugins/incident-pagerduty-buildkite-plugin.git#73e5852:
          integration-key: ${INTEGRATION_KEY}
        
secrets:
  INTEGRATION_KEY: pagerduty_integration_key
  BUILDKITE_API_TOKEN: api_token
